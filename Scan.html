<script>
    // === GLOBAL VARIABLES ===
    const appContainer = document.getElementById('app-container');
    
    // === HELPER FUNCTIONS (No changes needed, they work with the new design) ===
    function showAlert(title, message, cb) {
        const dialog = document.getElementById('customAlertDialog');
        dialog.querySelector('#customAlertTitle').textContent = title;
        dialog.querySelector('#customAlertMessage').textContent = message;
        dialog.classList.add('active');
        const btn = dialog.querySelector('#customAlertButton');
        const handler = () => { dialog.classList.remove('active'); btn.removeEventListener('click', handler); if(cb) cb(); };
        btn.addEventListener('click', handler, {once: true});
    }
    function showConfirm(title, message) {
        return new Promise(res => {
            const dialog = document.getElementById('customConfirmDialog');
            dialog.querySelector('#customConfirmTitle').textContent = title;
            dialog.querySelector('#customConfirmMessage').textContent = message;
            dialog.classList.add('active');
            const ok = dialog.querySelector('#customConfirmConfirmButton'), no = dialog.querySelector('#customConfirmCancelButton');
            const onOk = () => { cleanup(); res(true); }, onNo = () => { cleanup(); res(false); };
            function cleanup() { dialog.classList.remove('active'); ok.removeEventListener('click', onOk); no.removeEventListener('click', onNo); }
            ok.addEventListener('click', onOk, { once: true });
            no.addEventListener('click', onNo, { once: true });
        });
    }
    async function fetchData(action, params = {}) { const url = new URL(CONFIG.GAS_URL_ADMIN); url.searchParams.append('action', action); for (const k in params) { if (params[k]) url.searchParams.append(k, params[k]); } try { const r = await fetch(url); if (!r.ok) throw new Error(`Server responded with status: ${r.status}`); const data = await r.json(); if(data.error) throw new Error(data.error); return data; } catch (e) { showAlert('Error', `Fetch failed: ${e.message}`); throw e; } }
    async function postData(action, data) { try { const r = await fetch(CONFIG.GAS_URL_ADMIN, { method: 'POST', body: JSON.stringify({ action, ...data }) }); if (!r.ok) throw new Error(`Server responded with status: ${r.status}`); const responseText = await r.text(); try { const jsonData = JSON.parse(responseText); if(jsonData.success === false) throw new Error(jsonData.error || 'Unknown error'); return jsonData.message || responseText; } catch (jsonError) { return responseText; } } catch (e) { showAlert('Error', `Request failed: ${e.message}`); throw e; } }

    // === APP LOGIC (UPDATED) ===
    async function initCashierPage() {
        // [IMPROVEMENT] - Scanners are now managed more cleanly
        let claimScanner = null; 
        let customerScanner = null;
        
        // --- Tab Switching Logic ---
        const tabsContainer = document.getElementById('main-tabs-container');
        const tabButtons = tabsContainer.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        function switchTab(tabId) {
            // [CRITICAL FIX] - Stop all scanners before switching tabs to prevent camera from running in the background.
            stopClaimScanner();
            stopCustomerScanner();

            tabButtons.forEach(btn => {
                btn.classList.toggle('text-blue-600', btn.dataset.tab === tabId);
                btn.classList.toggle('border-blue-600', btn.dataset.tab === tabId);
                btn.classList.toggle('text-gray-500', btn.dataset.tab !== tabId);
                btn.classList.toggle('border-transparent', btn.dataset.tab !== tabId);
            });
            tabPanels.forEach(panel => {
                panel.classList.toggle('hidden', panel.id !== `${tabId}-tab-panel`);
            });
            if (tabId === 'history') { loadHistory(); }
        }
        tabsContainer.addEventListener('click', (e) => {
            if(e.target.matches('.tab-button')) { switchTab(e.target.dataset.tab); }
        });
        
        // --- Scan Claim Logic (Updated to match the original robust version) ---
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const scanResultEl = document.getElementById('scan-result');

        const onScanSuccessClaim = async (decodedText) => { 
            await stopClaimScanner(); 
            // Show a temporary loading state
            scanResultEl.innerHTML = `<div class="inline-block h-5 w-5 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"></div>`; 
            try { 
                const responseText = await postData('claimItemByUniqueId', { uniqueId: decodedText }); 
                showAlert('ผลการยืนยัน', responseText); 
                scanResultEl.innerHTML = responseText.includes('สำเร็จ') ? `<span class="text-green-600">✅ ${responseText}</span>` : `<span class="text-orange-600">⚠️ ${responseText}</span>`; 
            } catch (error) { 
                scanResultEl.innerHTML = `<span class="text-red-600">❌ ${error.message}</span>`; 
            } 
        };

        const startClaimScanner = () => { 
            if (!claimScanner) { claimScanner = new Html5Qrcode("qr-reader"); } 
            // Prevent starting if already scanning
            if (claimScanner && claimScanner.isScanning) { return; }
            
            claimScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccessClaim, () => {})
                .then(() => { 
                    startScanBtn.classList.add('hidden'); 
                    stopScanBtn.classList.remove('hidden'); 
                    scanResultEl.textContent = 'กรุณาหันกล้องไปที่ QR Code'; 
                }).catch(err => { 
                    showAlert("ข้อผิดพลาด", "ไม่สามารถเปิดกล้องได้ กรุณาตรวจสอบการอนุญาตใช้งานกล้อง"); 
                }); 
        };
        
        const stopClaimScanner = async () => { 
            if (claimScanner && claimScanner.isScanning) { 
                try { 
                    await claimScanner.stop(); 
                } catch (err) { 
                    console.error("Failed to stop claim scanner.", err);
                }
            }
            // Always reset button states
            startScanBtn.classList.remove('hidden'); 
            stopScanBtn.classList.add('hidden'); 
        };
        
        startScanBtn.onclick = startClaimScanner; 
        stopScanBtn.onclick = stopClaimScanner;

        // --- Scan Customer Logic ---
        const scanCustomerModal = document.getElementById('scanCustomerModal');
        const scanCustomerBtn = document.getElementById('scanCustomerBtn');
        const closeScanCustomerBtn = document.getElementById('closeScanCustomerBtn');
        const customerIdentifierInput = document.getElementById('addPointsIdentifier');

        const onScanSuccessCustomer = async (decodedText) => { 
            customerIdentifierInput.value = decodedText;
            customerIdentifierInput.focus(); 
            await stopCustomerScanner(); 
        };
        
        const startCustomerScanner = () => { 
            if (!customerScanner) { customerScanner = new Html5Qrcode("customer-qr-reader"); }
            if (customerScanner && customerScanner.isScanning) { return; }

            scanCustomerModal.classList.add('active'); 
            customerScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccessCustomer, () => {})
                .catch(err => { 
                    showAlert("ข้อผิดพลาด", "ไม่สามารถเปิดกล้องสแกนลูกค้าได้"); 
                    scanCustomerModal.classList.remove('active'); 
                }); 
        };

        const stopCustomerScanner = async () => { 
            if (customerScanner && customerScanner.isScanning) { 
                try { 
                    await customerScanner.stop(); 
                } catch (err) { 
                    console.error("Failed to stop customer scanner.", err);
                } 
            }
            // Always close the modal
            scanCustomerModal.classList.remove('active'); 
        };
        
        scanCustomerBtn.onclick = startCustomerScanner; 
        closeScanCustomerBtn.onclick = stopCustomerScanner;

        // --- Add Points (POS) Logic (No changes needed, it was already well-structured) ---
        const addPointsForm = document.getElementById('addPointsForm'), addPointsSubmitBtn = document.getElementById('addPointsSubmitBtn'), productModeSection = document.getElementById('productModeSection'), manualModeSection = document.getElementById('manualModeSection'), productListSelect = document.getElementById('productList'), quantityInput = document.getElementById('productQuantity'), addItemBtn = document.getElementById('addItemToBillBtn'), billContainer = document.getElementById('billItemsContainer'), totalPointsDisplay = document.getElementById('totalPointsDisplay'), posModeContainer = document.getElementById('pos-mode-container');
        let allProducts = [], billItems = [], currentPosMode = 'product';
        try { allProducts = await fetchData('getProducts'); updateProductDropdown(); } catch (e) { productListSelect.innerHTML = `<option disabled selected>โหลดสินค้าล้มเหลว</option>`; }
        function updateProductDropdown() { const productIdsInBill = billItems.map(item => item.id); const availableProducts = allProducts.filter(p => !productIdsInBill.includes(p.id)); productListSelect.innerHTML = ''; if (availableProducts.length > 0) { availableProducts.forEach(p => { const option = document.createElement('option'); option.value = p.id; option.textContent = `${p.name} (${p.points} แต้ม)`; productListSelect.appendChild(option); }); } else { productListSelect.innerHTML = '<option disabled selected>เพิ่มสินค้าครบแล้ว</option>'; } }
        function renderBill() { billContainer.innerHTML = ''; let totalPoints = 0; if (billItems.length === 0) { billContainer.innerHTML = '<p class="text-center text-gray-400">ยังไม่มีรายการ</p>'; totalPointsDisplay.textContent = '0'; return; } billItems.forEach(item => { const itemPoints = item.points * item.quantity; totalPoints += itemPoints; const itemDiv = document.createElement('div'); itemDiv.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-md'; itemDiv.innerHTML = `<div><span class="font-semibold text-gray-800">${item.name}</span> <span class="text-sm text-gray-500">x ${item.quantity}</span></div><div><span class="font-bold text-blue-600">${itemPoints} แต้ม</span><button type="button" class="ml-2 p-1 remove-item-btn text-red-500 hover:bg-red-100 rounded-full" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>`; billContainer.appendChild(itemDiv); }); totalPointsDisplay.textContent = totalPoints.toLocaleString(); billContainer.querySelectorAll('.remove-item-btn').forEach(btn => { btn.onclick = (e) => { billItems = billItems.filter(item => item.id !== e.currentTarget.dataset.id); renderBill(); updateProductDropdown(); }; }); }
        posModeContainer.addEventListener('click', (e) => { if(e.target.matches('.pos-mode-button')) { currentPosMode = e.target.dataset.mode; posModeContainer.querySelectorAll('.pos-mode-button').forEach(b => {b.classList.toggle('bg-gray-800', b.dataset.mode === currentPosMode); b.classList.toggle('text-white', b.dataset.mode === currentPosMode);}); productModeSection.classList.toggle('hidden', currentPosMode !== 'product'); manualModeSection.classList.toggle('hidden', currentPosMode !== 'manual'); }});
        addItemBtn.onclick = () => { const selectedId = productListSelect.value; if (!selectedId) return; const product = allProducts.find(p => p.id === selectedId); const quantity = parseInt(quantityInput.value, 10); if (product && quantity > 0) { billItems.push({ ...product, quantity }); renderBill(); updateProductDropdown(); quantityInput.value = 1; } };
        addPointsForm.onsubmit = async (e) => { e.preventDefault(); const identifier = document.getElementById('addPointsIdentifier').value.trim(); if (!identifier) return showAlert('ข้อมูลไม่ครบ', 'กรุณาระบุลูกค้า'); let payload = { identifier }, confirmMessage = ''; if (currentPosMode === 'product') { if (billItems.length === 0) return showAlert('ข้อมูลไม่ครบ', 'กรุณาเพิ่มสินค้าลงในบิล'); payload.itemsPurchased = billItems.map(item => ({ productId: item.id, quantity: item.quantity })); const totalPoints = billItems.reduce((sum, item) => sum + (item.points * item.quantity), 0); const itemSummary = billItems.map(item => `${item.name} x${item.quantity}`).join(',\n'); confirmMessage = `ยืนยันให้ ${totalPoints} แต้ม\nจาก:\n${itemSummary}\n\nสำหรับผู้ใช้: "${identifier}"?`; } else { const points = document.getElementById('addPointsAmount').value; const reason = document.getElementById('addPointsReason').value.trim(); if (!points || parseInt(points) < 1 || !reason) return showAlert('ข้อมูลไม่ครบ', 'กรุณากรอกแต้มและเหตุผล'); payload.points = parseInt(points, 10); payload.reason = reason; confirmMessage = `ยืนยันให้ ${payload.points} แต้ม\nเหตุผล: ${payload.reason}\n\nสำหรับผู้ใช้: "${identifier}"?`; } if (await showConfirm('ยืนยันการให้แต้ม', confirmMessage)) { addPointsSubmitBtn.classList.add('opacity-50', 'cursor-not-allowed'); addPointsSubmitBtn.disabled = true; try { const message = await postData('addPointsToUser', payload); showAlert('สำเร็จ', message || 'เพิ่มแต้มเรียบร้อยแล้ว'); addPointsForm.reset(); billItems = []; renderBill(); updateProductDropdown(); } catch(e) {} finally { addPointsSubmitBtn.classList.remove('opacity-50', 'cursor-not-allowed'); addPointsSubmitBtn.disabled = false; } } };
        renderBill();
        posModeContainer.querySelector('[data-mode="product"]').click(); 
        
        // --- Recent History Logic ---
        const historyTableBody = document.getElementById('historyTableBody'), refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
        function parseGASDate(dateString) { const parts = dateString.split(/[\s/:]/); if (parts.length < 6) return new Date(dateString); return new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5]); }
        const transactionTypeMap = { 'purchase': { text: 'ซื้อสินค้า', style: 'bg-blue-100 text-blue-800' }, 'admin_add': { text: 'Admin เพิ่ม', style: 'bg-indigo-100 text-indigo-800' }, 'redeem': { text: 'แลกของ', style: 'bg-red-100 text-red-800' }, 'event': { text: 'กิจกรรม', style: 'bg-purple-100 text-purple-800' }, 'code': { text: 'ใช้โค้ด', style: 'bg-yellow-100 text-yellow-800' }, 'checkin': { text: 'เช็คอิน', style: 'bg-green-100 text-green-800' }, 'default': { text: 'อื่นๆ', style: 'bg-gray-100 text-gray-800' } };
        async function loadHistory() { historyTableBody.innerHTML = `<tr><td colspan="4" class="py-12 text-center"><span class="loading-spinner mx-auto"></span></td></tr>`; try { const history = await fetchData('getAllHistory', { limit: 20 }); if (!history.length) { historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">ไม่พบประวัติ</td></tr>`; return; } historyTableBody.innerHTML = history.map(h => { const dateObj = parseGASDate(h.date); const formattedDate = !isNaN(dateObj) ? dateObj.toLocaleString('th-TH', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'}) : 'Invalid Date'; const typeInfo = transactionTypeMap[h.type] || transactionTypeMap['default']; return `<tr class="border-b border-gray-200"><td class="px-4 py-3 text-gray-500">${formattedDate}</td><td class="px-4 py-3"><span class="px-2 py-1 text-xs font-medium rounded-full ${typeInfo.style}">${typeInfo.text}</span></td><td class="px-4 py-3 max-w-xs truncate">${h.detail}</td><td class="px-4 py-3 font-bold text-right ${h.amount < 0 ? 'text-red-600' : 'text-green-600'}">${h.amount > 0 ? '+' : ''}${h.amount}</td></tr>`; }).join(''); } catch (e) { historyTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Load failed</td></tr>`; } }
        refreshHistoryBtn.onclick = loadHistory;

        // Initialize first tab
        switchTab('scan');
    }

    // --- App Start ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof CONFIG === 'undefined' || !CONFIG.GAS_URL_ADMIN) { const gasUrl = prompt("Please enter your Google Apps Script URL:"); if (gasUrl) { window.CONFIG = { GAS_URL_ADMIN: gasUrl }; } else { document.body.innerHTML = '<div class="p-8 text-center text-error">Configuration not found. Please create config-admin.js or enter the URL.</div>'; return; } }
        const template = document.getElementById('view-cashier-page');
        if(template) { appContainer.innerHTML = ''; appContainer.appendChild(template.content.cloneNode(true)); initCashierPage(); } 
        else { appContainer.innerHTML = "Error: Main template not found."; }
    });
</script>
