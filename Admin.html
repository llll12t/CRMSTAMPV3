<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Admin</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind CSS Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'thm-bg': '#ECE6E2', // Main background color
            'thm-primary': '#866147', // Primary action/accent color
            'thm-secondary': '#A67F68', // A lighter shade of primary for secondary actions
            'thm-accent': '#C5A894', // A light accent color
            'thm-primary-dark': '#6c4e38', // Darker shade for hover
            'thm-secondary-dark': '#85634d', // Darker shade for hover
          },
        },
      },
    };
  </script>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    /* Use Inter font and fallback to Kanit for Thai */
    body { font-family: 'Inter', 'Kanit', sans-serif; }
    
    /* QR Scanner custom style */
    #qr-shaded-region{ border-width:0 !important; }
    
    /* Modern Loading Spinner Animation */
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #866147; /* Use your primary color */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    /* Mobile sidebar logic */
    #my-drawer-2:checked ~ .drawer-side { transform: translateX(0); }
    #my-drawer-2:checked ~ .drawer-overlay { opacity: 1; pointer-events: auto; }

    /* Dialog backdrop style */
    dialog::backdrop {
      background-color: rgba(0, 0, 0, 0.5);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }
  </style>
</head>

<body class="bg-thm-bg">
  <!-- Login Overlay -->
  <div id="login-overlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 p-4">
      <div class="w-full max-w-sm bg-white shadow-xl border border-gray-200 rounded-2xl">
          <div class="p-8">
              <h2 class="text-center text-2xl font-bold mb-6 text-gray-800">Admin Login</h2>
              <div id="login-error" class="text-red-500 text-center text-sm hidden mb-4"></div>
              <div class="mb-4">
                  <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input type="text" id="username" placeholder="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" />
              </div>
              <div class="mb-6">
                  <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input type="password" id="password" placeholder="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" />
              </div>
              <div class="mt-8">
                  <button id="loginBtn" class="w-full inline-flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-thm-primary disabled:opacity-50">Login</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Main App Content (hidden until logged in) -->
  <div id="main-app" class="relative min-h-screen lg:grid lg:grid-cols-[18rem_1fr] hidden">
    <input id="my-drawer-2" type="checkbox" class="hidden" />
    
    <!-- Sidebar -->
    <aside class="drawer-side w-72 min-h-full bg-white text-gray-800 border-r border-gray-200 fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0">
        <div class="p-4">
            <div class="text-2xl font-bold p-4 mb-4 text-gray-900">CRM Panel</div>
            <ul id="main-menu" class="space-y-1">
              <!-- Menu items will be generated here -->
            </ul>
        </div>
    </aside>
    <!-- Overlay for mobile sidebar -->
    <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay fixed inset-0 bg-black bg-opacity-30 z-30 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"></label>

    <!-- Main Content -->
    <div class="drawer-content flex flex-col bg-gray-50">
      <header class="flex items-center bg-white shadow-sm px-4 py-2 sticky top-0 z-20 border-b border-gray-200 h-16">
        <div class="lg:hidden">
            <label for="my-drawer-2" aria-label="open sidebar" class="p-2 rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </label>
        </div>
        <div class="flex-1 px-2 mx-2"><h1 class="text-xl font-bold text-gray-800" id="pageTitle">ภาพรวม</h1></div>
        <div class="flex-none"><button id="logoutBtn" class="px-3 py-1.5 text-sm font-medium rounded-lg text-gray-600 bg-transparent hover:bg-gray-200 transition-colors duration-200">Logout</button></div>
      </header>
      <main class="flex-grow p-4 sm:p-6 lg:p-8">
        <div id="app-container" class="transition-opacity duration-300">
            <div class="flex flex-col items-center justify-center gap-4 p-8 text-gray-500">
                <div class="loading-spinner"></div>
                <p>กำลังโหลด...</p>
            </div>
        </div>
      </main>
    </div>
  </div>

  <!-- MODALS -->
  <dialog id="customAlertDialog" class="p-0 m-auto bg-transparent">
    <div class="p-8 bg-white rounded-2xl shadow-xl max-w-sm w-full text-center">
      <h3 id="customAlertTitle" class="font-bold text-lg mb-3 text-gray-900"></h3>
      <p id="customAlertMessage" class="py-4 whitespace-pre-line text-gray-600"></p>
      <div class="mt-6">
        <form method="dialog">
            <button class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">ตกลง</button>
        </form>
      </div>
    </div>
  </dialog>
  <dialog id="customConfirmDialog" class="p-0 m-auto bg-transparent">
      <div class="p-8 bg-white rounded-2xl shadow-xl max-w-sm w-full text-center">
          <h3 id="customConfirmTitle" class="font-bold text-lg mb-3 text-gray-900"></h3>
          <p id="customConfirmMessage" class="py-4 whitespace-pre-line text-gray-600"></p>
          <div class="mt-6 flex justify-around gap-4">
              <button id="customConfirmCancelButton" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-gray-300 text-base font-medium rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50">ยกเลิก</button>
              <button id="customConfirmConfirmButton" class="flex-1 inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">ยืนยัน</button>
          </div>
      </div>
  </dialog>
  <dialog id="dataFormModal" class="p-0 m-auto bg-transparent">
      <div class="p-8 bg-white rounded-2xl shadow-xl max-w-lg w-full">
          <h3 id="dataFormModalTitle" class="font-bold text-lg mb-6 text-gray-900"></h3>
          <form id="dataForm" onsubmit="event.preventDefault()">
              <div id="formFields" class="grid grid-cols-1 gap-4"></div>
              <div class="mt-8 flex justify-end gap-3">
                  <button type="button" id="formCancelBtn" class="px-4 py-2 text-base font-medium rounded-lg text-gray-600 bg-transparent hover:bg-gray-100">ยกเลิก</button>
                  <button type="submit" id="formSaveBtn" class="px-4 py-2 text-base font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark disabled:opacity-50">บันทึก</button>
              </div>
          </form>
      </div>
  </dialog>
  <dialog id="qrCodeModal" class="p-0 m-auto bg-transparent">
      <div class="p-8 bg-white rounded-2xl shadow-xl max-w-sm w-full text-center">
          <h3 id="qrCodeModalTitle" class="font-bold text-lg mb-4 text-gray-900">QR Code</h3>
          <div id="qrCodeCanvas" class="flex justify-center p-4 bg-white rounded-lg my-4 border"></div>
          <p class="text-sm text-gray-500 mb-6">คลิกขวาที่รูปเพื่อบันทึก</p>
          <div class="mt-6">
              <form method="dialog">
                  <button class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">ปิด</button>
              </form>
          </div>
      </div>
  </dialog>

  <!-- TEMPLATES (Generic Table Template) -->
  <template id="view-table-generic">
    <div class="text-right mb-6"><button id="addNewBtn" class="inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-secondary hover:bg-thm-secondary-dark"></button></div>
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 text-left"><tr id="tableHeaderRow" class="text-gray-700 font-semibold uppercase"></tr></thead>
            <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
    </div>
  </template>

  <!-- SPECIFIC VIEW TEMPLATES -->
  <template id="view-dashboard">
    <div class="space-y-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-0 shadow-lg bg-white rounded-2xl border border-gray-200 overflow-hidden">
            <div class="p-6 text-center border-b md:border-b-0 md:border-r border-gray-200"><div class="text-sm text-gray-500">ผู้ใช้ทั้งหมด</div><div id="statTotalUsers" class="text-4xl font-bold mt-1 text-thm-primary">0</div><div id="statNewUsersToday" class="text-sm text-gray-600 mt-1"></div></div>
            <div class="p-6 text-center border-b md:border-b-0 md:border-r border-gray-200"><div class="text-sm text-gray-500">ของรางวัล</div><div id="statTotalItems" class="text-4xl font-bold mt-1 text-thm-primary">0</div><div id="statRedeemedItems" class="text-sm text-gray-600 mt-1"></div></div>
            <div class="p-6 text-center"><div class="text-sm text-gray-500">กิจกรรม & โค้ด</div><div id="statTotalEvents" class="text-4xl font-bold mt-1 text-thm-primary">0</div><div id="statTotalCodes" class="text-sm text-gray-600 mt-1"></div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white shadow-lg rounded-2xl border border-gray-200 p-6"><h3 class="text-xl font-semibold mb-4 text-gray-800">ผู้ใช้ตามระดับ (LV)</h3><div class="relative h-64"><canvas id="userLevelChart"></canvas></div></div>
            <div class="bg-white shadow-lg rounded-2xl border border-gray-200 p-6"><h3 class="text-xl font-semibold mb-4 text-gray-800">สถิติพ้อยต์ (รับ/ใช้)</h3><div class="relative h-64"><canvas id="pointStatsChart"></canvas></div></div>
        </div>
    </div>
  </template>
  
  <template id="view-users">
      <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
          <input type="text" id="userSearchInput" placeholder="ค้นหา (LINE ID / ชื่อ / เบอร์โทร)" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" />
          <div class="flex gap-2 w-full sm:w-auto">
            <button id="userSearchBtn" class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">ค้นหา</button>
            <button id="addUserBtn" class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-secondary hover:bg-thm-secondary-dark">เพิ่มผู้ใช้ใหม่</button>
          </div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
          <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 text-left"><tr class="text-gray-700 font-semibold uppercase"><th class="px-4 py-3">LINE ID</th><th class="px-4 py-3">ชื่อ</th><th class="px-4 py-3">เบอร์โทร</th><th class="px-4 py-3">พ้อยต์</th><th class="px-4 py-3">แสตมป์</th><th class="px-4 py-3">ระดับ</th><th class="px-4 py-3">Tags</th><th class="px-4 py-3">จัดการ</th></tr></thead><tbody id="userTableBody" class="divide-y divide-gray-200"></tbody></table></div>
      </div>
  </template>

  <template id="view-add-points">
    <div class="bg-white shadow-lg max-w-2xl mx-auto rounded-2xl border border-gray-200">
        <div class="p-6 md:p-8">
            <form id="addPointsForm" onsubmit="event.preventDefault()" class="space-y-6">
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-2">1. ระบุลูกค้า</label>
                    <input type="text" id="addPointsIdentifier" placeholder="กรอก Line ID, เบอร์โทร หรือสแกน QR ลูกค้า" class="w-full text-lg px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" required />
                </div>
                <div>
                    <label class="block text-lg font-semibold text-gray-800 mb-2">2. เลือกวิธีให้แต้ม</label>
                    <div role="tablist" id="pos-mode-tabs" class="flex bg-gray-100 rounded-lg p-1">
                        <button type="button" role="tab" class="flex-1 py-2 px-4 text-center rounded-md cursor-pointer transition-colors duration-200 bg-thm-primary text-white shadow" data-mode="product">จากรายการสินค้า</button>
                        <button type="button" role="tab" class="flex-1 py-2 px-4 text-center rounded-md cursor-pointer transition-colors duration-200 text-gray-700" data-mode="manual">กรอกแต้มเอง</button>
                    </div>
                </div>
                <div id="productModeSection" class="space-y-4 pt-4">
                    <div class="relative flex items-center py-2"><div class="flex-grow border-t border-gray-300"></div><span class="flex-shrink mx-4 text-gray-500">รายการสินค้าในบิล</span><div class="flex-grow border-t border-gray-300"></div></div>
                    <div id="billItemsContainer" class="space-y-2 max-h-60 overflow-y-auto pr-2 border-b pb-4"><p class="text-center text-gray-400">ยังไม่มีรายการ</p></div>
                    <div class="flex flex-col sm:flex-row sm:items-end gap-2 p-4 bg-gray-50 rounded-lg">
                        <div class="flex-grow"><label for="productList" class="block text-sm font-medium text-gray-600 mb-1">เลือกสินค้า</label><select id="productList" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary"><option disabled selected>กำลังโหลด...</option></select></div>
                        <div class="w-full sm:w-24"><label for="productQuantity" class="block text-sm font-medium text-gray-600 mb-1">จำนวน</label><input type="number" id="productQuantity" value="1" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" /></div>
                        <button type="button" id="addItemToBillBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-secondary hover:bg-thm-secondary-dark">เพิ่ม</button>
                    </div>
                    <div class="text-right text-xl font-bold pt-4">แต้มที่จะได้รับรวม: <span id="totalPointsDisplay" class="text-thm-primary">0</span> แต้ม</div>
                </div>
                <div id="manualModeSection" class="space-y-4 pt-4 hidden">
                    <div><label for="addPointsAmount" class="block text-sm font-medium text-gray-700 mb-1">จำนวนแต้ม</label><input type="number" id="addPointsAmount" placeholder="เช่น 50" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" min="0" /></div>
                    <div><label for="addPointsReason" class="block text-sm font-medium text-gray-700 mb-1">เหตุผล</label><input type="text" id="addPointsReason" placeholder="เช่น ของขวัญพิเศษ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" /></div>
                </div>
                <div class="border-t pt-6">
                    <label class="block text-lg font-semibold text-gray-800 mb-2">ให้แสตมป์เพิ่มเติม (ถ้ามี)</label>
                    <input type="number" id="addStampsAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" placeholder="กรอกจำนวนแสตมป์" value="0" min="0" />
                    <p class="text-sm text-gray-500 mt-1">ใส่ 0 หากไม่ต้องการให้แสตมป์ ระบบจะสะสมให้สูงสุดไม่เกิน 10 ดวง</p>
                </div>
                <div class="pt-4"><button type="submit" id="addPointsSubmitBtn" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-xl font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark disabled:opacity-50">ยืนยันและให้แต้ม</button></div>
            </form>
        </div>
    </div>
  </template>

  <template id="view-warehouse">
      <div class="flex flex-wrap gap-4 mb-6"><input type="text" id="warehouseSearchInput" placeholder="ค้นหา..." class="flex-grow w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" /><select id="warehouseStatusFilter" class="w-full md:w-auto px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary"><option value="">-- ทุกสถานะ --</option><option value="pending_claim" selected>รอรับ/จัดส่ง</option><option value="claimed">รับแล้ว</option></select><button id="warehouseSearchBtn" class="inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">ค้นหา</button></div>
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 text-left"><tr class="text-gray-700 font-semibold uppercase"><th class="px-4 py-3">ID</th><th class="px-4 py-3">ของรางวัล</th><th class="px-4 py-3">ผู้ใช้</th><th class="px-4 py-3">ข้อมูลจัดส่ง</th><th class="px-4 py-3">วันที่แลก</th><th class="px-4 py-3">สถานะ</th><th class="px-4 py-3">จัดการ</th></tr></thead><tbody id="warehouseTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
  </template>
  
  <template id="view-scan-claim">
      <div class="bg-white shadow-lg max-w-lg mx-auto rounded-2xl border border-gray-200">
          <div class="p-6 text-center">
              <div id="qr-reader" class="w-full max-w-xs h-64 mx-auto bg-gray-100 rounded-lg mb-6 border-2 border-dashed border-gray-300 overflow-hidden"></div>
              <div class="w-full flex flex-col gap-2">
                  <button id="startScanBtn" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">เริ่มสแกน</button>
                  <button id="stopScanBtn" class="w-full inline-flex items-center justify-center px-4 py-2 rounded-lg text-gray-600 bg-gray-200 hover:bg-gray-300 hidden">หยุดสแกน</button>
              </div>
              <div id="scan-result" class="mt-4 text-lg font-semibold h-8"></div>
          </div>
      </div>
  </template>
  
  <template id="view-history">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 items-end">
        <input type="text" id="historySearchLineId" placeholder="ค้นหาด้วย Line ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" />
        <select id="historyFilterType" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary"><option value="">-- ประเภททั้งหมด --</option><option value="purchase">การซื้อสินค้า</option><option value="admin_add">Admin เพิ่มแต้ม</option><option value="checkin">เช็คอิน</option><option value="event">กิจกรรม</option><option value="code">โค้ด</option><option value="redeem">แลกของ</option><option value="transfer_in">รับโอน</option><option value="transfer_out">โอนออก</option></select>
        <input type="date" id="historyStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" placeholder="จากวันที่">
        <input type="date" id="historyEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" placeholder="ถึงวันที่">
        <div class="flex gap-2"><button id="historyFilterBtn" class="flex-grow inline-flex items-center justify-center px-4 py-2 border border-transparent font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark">กรอง</button><button id="historyResetBtn" class="flex-grow inline-flex items-center justify-center px-4 py-2 rounded-lg text-gray-600 bg-gray-200 hover:bg-gray-300">รีเซ็ต</button></div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 text-left"><tr class="text-gray-700 font-semibold uppercase"><th class="px-4 py-3">Line ID</th><th class="px-4 py-3">ประเภท</th><th class="px-4 py-3">รายละเอียด</th><th class="px-4 py-3">จำนวน</th><th class="px-4 py-3">วันที่</th><th class="px-4 py-3">ID อ้างอิง</th></tr></thead><tbody id="historyTableBody" class="divide-y divide-gray-200"></tbody></table></div></div>
  </template>
  
  <template id="view-settings">
      <div class="bg-white shadow-lg max-w-lg mx-auto rounded-2xl border border-gray-200">
        <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-800">การตั้งค่าระดับผู้ใช้</h3>
            <p class="text-sm text-gray-600 mb-6">กำหนดแต้มขั้นต่ำเพื่อเลื่อนระดับ</p>
            <form id="levelSettingsForm" onsubmit="event.preventDefault()" class="space-y-4">
                <div>
                    <label for="vipPoints" class="block text-sm font-medium text-gray-700 mb-1">แต้มสำหรับระดับ VIP</label>
                    <input type="number" id="vipPoints" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" required min="0" />
                </div>
                <div>
                    <label for="superPoints" class="block text-sm font-medium text-gray-700 mb-1">แต้มสำหรับระดับ SUPER</label>
                    <input type="number" id="superPoints" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-thm-primary focus:ring-1 focus:ring-thm-primary" required min="0" />
                </div>
                <div class="pt-4">
                    <button type="submit" id="saveLevelSettingsBtn" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-thm-primary hover:bg-thm-primary-dark disabled:opacity-50">บันทึกการตั้งค่า</button>
                </div>
            </form>
        </div>
      </div>
  </template>


<script>
    // ==========================================================
    // ===                 GLOBAL CONFIGURATION               ===
    // ==========================================================
    const CONFIG = {
        // *** สำคัญ: ใส่ URL ของ Google Apps Script ของคุณที่นี่ ***
        GAS_URL_ADMIN: "YOUR_GOOGLE_APPS_SCRIPT_ADMIN_URL_HERE" 
    };
    
    // ==========================================================
    // ===                 GLOBAL VARIABLES                   ===
    // ==========================================================
    const mainApp = document.getElementById('main-app');
    const appContainer = document.getElementById('app-container');
    const drawerToggle = document.getElementById('my-drawer-2');
    const pageTitle = document.getElementById('pageTitle');

    const dataFormModal = document.getElementById('dataFormModal');
    const dataFormModalTitle = document.getElementById('dataFormModalTitle');
    const formFieldsContainer = document.getElementById('formFields');
    const formSaveBtn = document.getElementById('formSaveBtn');
    const formCancelBtn = document.getElementById('formCancelBtn');

    const USER_LEVELS = ['MEMBER', 'VIP', 'SUPER'];
    let levelConfig = { VIP_points: 100, SUPER_points: 500 };

    const MENU_STRUCTURE = [
        { title: 'เมนูหลัก' },
        { name: 'ภาพรวม', href: '#dashboard' },
        { name: 'จัดการผู้ใช้', href: '#users' },
        { name: 'เพิ่มแต้ม (POS)', href: '#add-points' },
        { title: 'จัดการข้อมูล' },
        { name: 'จัดการสินค้า', href: '#products' },
        { name: 'จัดการของรางวัล', href: '#items' },
        { name: 'จัดการกิจกรรม', href: '#events' },
        { name: 'จัดการโค้ด', href: '#codes' },
        { title: 'การดำเนินงาน' },
        { name: 'คลังสินค้า', href: '#warehouse' },
        { name: 'สแกนรับของ', href: '#scan-claim' },
        { name: 'ประวัติฯ', href: '#history' },
        { title: 'ตั้งค่า' },
        { name: 'ตั้งค่าระบบ', href: '#settings' },
    ];
    
    // ==========================================================
    // ===                 HELPER FUNCTIONS                   ===
    // ==========================================================
    function showAlert(title, message, cb) { 
        const dialog = document.getElementById('customAlertDialog'); 
        document.getElementById('customAlertTitle').textContent = title; 
        document.getElementById('customAlertMessage').textContent = message; 
        dialog.showModal(); 
        const closeHandler = () => { if (cb) cb(); };
        dialog.addEventListener('close', closeHandler, { once: true });
    }
    
    function showConfirm(title, message) { 
        return new Promise(res => { 
            const dialog = document.getElementById('customConfirmDialog'); 
            document.getElementById('customConfirmTitle').textContent = title; 
            document.getElementById('customConfirmMessage').textContent = message; 
            const okBtn = document.getElementById('customConfirmConfirmButton');
            const cancelBtn = document.getElementById('customConfirmCancelButton');
            
            const onOk = () => { cleanup(); res(true); };
            const onCancel = () => { cleanup(); res(false); };
            
            function cleanup() { dialog.close(); okBtn.removeEventListener('click', onOk); cancelBtn.removeEventListener('click', onCancel); }
            
            okBtn.addEventListener('click', onOk, { once: true });
            cancelBtn.addEventListener('click', onCancel, { once: true });
            dialog.showModal();
        }); 
    }
    
    async function fetchData(action, params = {}) { 
        const url = new URL(CONFIG.GAS_URL_ADMIN); 
        url.searchParams.append('action', action); 
        for (const k in params) { if (params[k]) url.searchParams.append(k, params[k]); } 
        try { 
            const r = await fetch(url); 
            if (!r.ok) throw new Error(`Server responded with status: ${r.status}`);
            const data = await r.json();
            if(data.error) throw new Error(data.error);
            return data;
        } catch (e) { showAlert('Error', `Fetch failed: ${e.message}`); throw e; } 
    }
    
    async function postData(action, data) { 
        const btn = document.querySelector('button:focus, button[type=submit].disabled');
        if (btn) btn.disabled = true;
        
        try { 
            const r = await fetch(CONFIG.GAS_URL_ADMIN, { method: 'POST', body: JSON.stringify({ action, ...data }) }); 
            if (!r.ok) throw new Error(`Server responded with status: ${r.status}`);
            const responseText = await r.text();
            try {
                const jsonData = JSON.parse(responseText);
                if(jsonData.success === false) throw new Error(jsonData.error || 'Unknown error from server');
                return jsonData.message || responseText;
            } catch (jsonError) { return responseText; }
        } catch (e) { 
            showAlert('Error', `Request failed: ${e.message}`); 
            throw e; 
        } finally {
            if(btn) btn.disabled = false;
        }
    }

    // ==========================================================
    // ===               ROUTER & AUTHENTICATION              ===
    // ==========================================================
    const routes = {
        '': { tpl: 'view-dashboard', init: initDashboard, title: "ภาพรวม" },
        '#dashboard': { tpl: 'view-dashboard', init: initDashboard, title: "ภาพรวม" },
        '#users': { tpl: 'view-users', init: initUsers, title: "จัดการผู้ใช้" },
        '#add-points': { tpl: 'view-add-points', init: initAddPoints, title: "เพิ่มแต้ม (POS)" },
        '#items': { tpl: 'view-table-generic', init: initGenericTableView, title: "จัดการของรางวัล", configKey: 'items' },
        '#products': { tpl: 'view-table-generic', init: initGenericTableView, title: "จัดการสินค้า", configKey: 'products' },
        '#warehouse': { tpl: 'view-warehouse', init: initWarehouse, title: "คลังสินค้า" },
        '#scan-claim': { tpl: 'view-scan-claim', init: initScanClaim, title: "สแกนรับของ" },
        '#events': { tpl: 'view-table-generic', init: initGenericTableView, title: "จัดการกิจกรรม", configKey: 'events' },
        '#codes': { tpl: 'view-table-generic', init: initGenericTableView, title: "จัดการโค้ด", configKey: 'codes' },
        '#history': { tpl: 'view-history', init: initHistory, title: "ประวัติการทำรายการ" },
        '#settings': { tpl: 'view-settings', init: initSettings, title: "ตั้งค่าระบบ" },
    };

    function setActiveNavLink(hash) { 
        document.querySelectorAll('#main-menu a').forEach(l => {
            const isActive = l.getAttribute('href') === hash;
            l.classList.toggle('bg-thm-primary', isActive);
            l.classList.toggle('text-white', isActive);
            l.classList.toggle('text-gray-700', !isActive);
            l.classList.toggle('hover:bg-gray-100', !isActive);
        }); 
        if (drawerToggle.checked) drawerToggle.checked = false; 
    }
    
    async function router() {
        if (!sessionStorage.getItem('isLoggedIn')) return;
        const hash = window.location.hash || '#dashboard';
        const route = routes[hash] || routes[''];

        pageTitle.textContent = route.title || "Loading...";
        appContainer.classList.add('opacity-50');
        appContainer.innerHTML = `<div class="flex flex-col items-center justify-center gap-4 p-8 text-gray-500"><div class="loading-spinner"></div><p>กำลังเปลี่ยนไปที่เมนู ${route.title}...</p></div>`;
        setActiveNavLink(hash);

        try {
            await fetchData('getLevelConfig').then(config => {
                if (config) levelConfig = { VIP_points: parseInt(config.VIP_points, 10), SUPER_points: parseInt(config.SUPER_points, 10) };
            });
        } catch(e) { console.warn("Could not fetch level config. Using defaults."); }

        const template = document.getElementById(route.tpl);
        if (template) { 
            appContainer.innerHTML = ''; 
            appContainer.appendChild(template.content.cloneNode(true)); 
            try { 
                if (route.configKey) {
                    await route.init(TABLE_CONFIGS[route.configKey]);
                } else {
                    await route.init();
                }
            } catch (e) { 
                appContainer.innerHTML = `<p class="text-red-500 text-center">Error loading page: ${e.message}</p>`; 
            }
        } else { 
            appContainer.innerHTML = `<p class="text-red-500 text-center">Page template not found: ${route.tpl}</p>`; 
        }
        appContainer.classList.remove('opacity-50');
    }
    
    function handleLogin() {
        const loginOverlay = document.getElementById('login-overlay'), loginBtn = document.getElementById('loginBtn'), userInput = document.getElementById('username'), passInput = document.getElementById('password'), loginError = document.getElementById('login-error');
        async function attemptLogin() { 
            loginBtn.disabled = true;
            loginError.classList.add('hidden'); 
            try { 
                const res = await fetch(CONFIG.GAS_URL_ADMIN, { method: 'POST', body: JSON.stringify({ action: 'login', username: userInput.value, password: passInput.value }) });
                const data = await res.json();
                if (data.success) { 
                    sessionStorage.setItem('isLoggedIn', 'true'); 
                    loginOverlay.classList.add('hidden'); 
                    mainApp.classList.remove('hidden'); 
                    await router(); 
                } 
                else { loginError.textContent = data.message || "Invalid credentials"; loginError.classList.remove('hidden'); } 
            } catch (e) { loginError.textContent = 'Login request failed.'; loginError.classList.remove('hidden'); } 
            finally { loginBtn.disabled = false; } 
        }
        loginBtn.onclick = attemptLogin; 
        passInput.addEventListener('keypress', (e) => e.key === 'Enter' && attemptLogin());
        document.getElementById('logoutBtn').onclick = () => { sessionStorage.removeItem('isLoggedIn'); location.reload(); };
        if (sessionStorage.getItem('isLoggedIn')) { loginOverlay.classList.add('hidden'); mainApp.classList.remove('hidden'); router(); }
    }

    // ==========================================================
    // ===                 PAGE INITIALIZERS                  ===
    // ==========================================================

    async function initDashboard() {
        const [sTotalUsers, sNewUsers, sTotalItems, sRedeemed, sTotalEvents, sTotalCodes] = ['statTotalUsers', 'statNewUsersToday', 'statTotalItems', 'statRedeemedItems', 'statTotalEvents', 'statTotalCodes'].map(id => document.getElementById(id));
        const userLevelChartCtx = document.getElementById('userLevelChart').getContext('2d'); 
        const pointStatsChartCtx = document.getElementById('pointStatsChart').getContext('2d');
        try { 
            const data = await fetchData('getDashboardData'); 
            sTotalUsers.textContent = data.users.length; 
            const todayStr = new Date().toDateString(); 
            sNewUsers.textContent = `+${data.users.filter(u => u.signupDate && new Date(u.signupDate).toDateString() === todayStr).length} วันนี้`; 
            sTotalItems.textContent = data.items.length; 
            sRedeemed.textContent = `แลกแล้ว ${data.allHistory.filter(h => h.type === 'redeem').length} ครั้ง`; 
            sTotalEvents.textContent = data.events.length; sTotalCodes.textContent = `${data.codes.length} โค้ด`; 
            const levelCounts = data.users.reduce((acc, user) => { const level = user.level || 'MEMBER'; acc[level.toUpperCase()] = (acc[level.toUpperCase()] || 0) + 1; return acc; }, { MEMBER: 0, VIP: 0, SUPER: 0 }); 
            if (window.userLevelChartInstance) window.userLevelChartInstance.destroy(); 
            window.userLevelChartInstance = new Chart(userLevelChartCtx, { type: 'bar', data: { labels: ['MEMBER', 'VIP', 'SUPER'], datasets: [{ label: 'จำนวน', data: [levelCounts.MEMBER, levelCounts.VIP, levelCounts.SUPER], backgroundColor: ['#C5A894', '#A67F68', '#866147'], borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } } } }); 
            const { earned, spent } = data.allHistory.reduce((acc, h) => { if (h.amount > 0 && h.type !== 'stamp_add') acc.earned += h.amount; else if(h.amount < 0) acc.spent += Math.abs(h.amount); return acc; }, { earned: 0, spent: 0 }); 
            if (window.pointStatsChartInstance) window.pointStatsChartInstance.destroy(); 
            window.pointStatsChartInstance = new Chart(pointStatsChartCtx, { type: 'doughnut', data: { labels: ['ได้รับ', 'ใช้ไป'], datasets: [{ data: [earned, spent], backgroundColor: ['#866147', '#C5A894'], borderColor: '#fff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%' } });
        } catch (e) { /* Error handled by fetchData */ }
    }

    async function initUsers() {
        const tableBody = document.getElementById('userTableBody'); 
        const searchInput = document.getElementById('userSearchInput'); 
        const searchBtn = document.getElementById('userSearchBtn'); 
        document.getElementById('addUserBtn').onclick = () => showUserFormModal(); 
        searchBtn.onclick = () => loadUsers(searchInput.value); 
        searchInput.addEventListener('keypress', e => e.key === 'Enter' && searchBtn.click()); 
        
        async function loadUsers(query) { 
            tableBody.innerHTML = `<tr><td colspan="8" class="py-12 text-center"><div class="inline-block loading-spinner"></div></td></tr>`; 
            try { 
                const users = await fetchData('getUsers', { query }); 
                renderUserTable(users); 
            } catch (e) { 
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500">Load failed</td></tr>`; 
            } 
        }

        function renderUserTable(users) { 
            if (!users.length) { 
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">ไม่พบข้อมูล</td></tr>`; 
                return; 
            } 
            tableBody.innerHTML = users.map(u => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-mono text-xs">${u.lineId}</td>
                    <td class="px-4 py-3 font-semibold">${u.name}</td>
                    <td class="px-4 py-3">${u.phone || '-'}</td>
                    <td class="px-4 py-3">${u.point.toLocaleString()}</td>
                    <td class="px-4 py-3 font-semibold text-center">${u.coffeeStamps || 0}</td>
                    <td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${u.level.toUpperCase() === 'SUPER' ? 'bg-thm-primary text-white' : u.level.toUpperCase() === 'VIP' ? 'bg-thm-secondary text-white' : 'bg-gray-200 text-gray-700'}">${u.level}</span></td>
                    <td class="px-4 py-3 max-w-xs truncate">${(u.tags || []).map(t => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-transparent border border-gray-300 text-gray-600 mr-1">${t}</span>`).join(' ')}</td>
                    <td class="px-4 py-3">
                        <div class="flex gap-2">
                            <button class="px-2 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 edit-btn">แก้ไข</button>
                            <button class="px-2 py-1 text-xs font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200 delete-btn">ลบ</button>
                        </div>
                    </td>
                </tr>`).join(''); 
            
            tableBody.querySelectorAll('.edit-btn').forEach((b, i) => {
                b.onclick = async () => { 
                    try { 
                        const user = await fetchData('getUserInfo', { lineId: users[i].lineId }); 
                        showUserFormModal(user); 
                    } catch (e) { /* handled */ } 
                }
            }); 
            
            tableBody.querySelectorAll('.delete-btn').forEach((b, i) => {
                b.onclick = () => deleteUser(users[i].lineId);
            }); 
        }

        function showUserFormModal(user = null) { 
            const isEdit = !!user; 
            dataFormModalTitle.textContent = isEdit ? 'แก้ไขผู้ใช้' : 'เพิ่มผู้ใช้'; 
            
            formFieldsContainer.innerHTML = `
                <div class="space-y-1">
                    <label for="formUserLineId" class="text-sm font-medium text-gray-700">Line ID</label>
                    <input type="text" id="formUserLineId" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                           ${isEdit ? 'readonly' : 'required'} value="${isEdit ? user.lineId : ''}">
                </div>
                <div class="space-y-1">
                    <label for="formUserName" class="text-sm font-medium text-gray-700">ชื่อ</label>
                    <input type="text" id="formUserName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                           required value="${isEdit ? user.name : ''}">
                </div>
                <div class="space-y-1">
                    <label for="formUserPhone" class="text-sm font-medium text-gray-700">เบอร์โทร</label>
                    <input type="tel" id="formUserPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                           value="${isEdit ? (user.phone || '') : ''}">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label for="formUserPoint" class="text-sm font-medium text-gray-700">พ้อยต์</label>
                        <input type="number" id="formUserPoint" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                               required value="${isEdit ? user.point : 0}" min="0">
                    </div>
                    <div class="space-y-1">
                        <label for="formUserCoffeeStamps" class="text-sm font-medium text-gray-700">แสตมป์</label>
                        <input type="number" id="formUserCoffeeStamps" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                               required value="${isEdit ? (user.coffeeStamps || 0) : 0}" min="0" max="10">
                    </div>
                </div>
                <div class="space-y-1">
                    <label for="formUserTags" class="text-sm font-medium text-gray-700">Tags (คั่นด้วย ,)</label>
                    <input type="text" id="formUserTags" class="w-full px-4 py-2 border border-gray-300 rounded-lg" 
                           value="${isEdit ? (user.tags || []).join(', ') : ''}">
                </div>
            `;
            
            if(isEdit) {
                document.getElementById('formUserLineId').classList.add('bg-gray-100');
            }

            dataFormModal.showModal(); 
            formSaveBtn.onclick = () => saveUser(isEdit); 
            formCancelBtn.onclick = () => dataFormModal.close(); 
        }
        
        async function saveUser(isEdit) { 
            const data = { 
                lineId: document.getElementById('formUserLineId').value.trim(), 
                name: document.getElementById('formUserName').value.trim(), 
                phone: document.getElementById('formUserPhone').value.trim(), 
                point: parseInt(document.getElementById('formUserPoint').value, 10), 
                coffeeStamps: parseInt(document.getElementById('formUserCoffeeStamps').value, 10),
                tags: document.getElementById('formUserTags').value.split(',').map(t => t.trim()).filter(Boolean) 
            }; 

            if (!data.lineId || !data.name) return showAlert('ข้อมูลไม่ครบ', 'Line ID และชื่อห้ามว่าง'); 
            if (isNaN(data.point) || isNaN(data.coffeeStamps)) return showAlert('ข้อมูลผิดพลาด', 'พ้อยต์และแสตมป์ต้องเป็นตัวเลข');

            formSaveBtn.disabled = true;
            try { 
                const action = isEdit ? 'updateUserAdmin' : 'registerAdmin';
                await postData(action, data); 
                showAlert('สำเร็จ', `ผู้ใช้ถูก${isEdit ? 'แก้ไข' : 'เพิ่ม'}แล้ว`, () => { 
                    dataFormModal.close(); 
                    loadUsers(); 
                }); 
            } catch(e) { /* showAlert handled in postData */ } 
            finally { formSaveBtn.disabled = false; } 
        }

        async function deleteUser(lineId) { 
            if (await showConfirm('ยืนยันการลบ', `ต้องการลบผู้ใช้ ${lineId} ใช่หรือไม่?`)) { 
                try { 
                    await postData('deleteUser', { lineId }); 
                    showAlert('สำเร็จ', 'ลบผู้ใช้เรียบร้อยแล้ว', () => loadUsers()); 
                } catch (e) { /* handled */ } 
            } 
        }

        await loadUsers();
    }
    
    async function initAddPoints() {
        const form = document.getElementById('addPointsForm'), submitBtn = document.getElementById('addPointsSubmitBtn'), productModeSection = document.getElementById('productModeSection'), manualModeSection = document.getElementById('manualModeSection'), productListSelect = document.getElementById('productList'), quantityInput = document.getElementById('productQuantity'), addItemBtn = document.getElementById('addItemToBillBtn'), billContainer = document.getElementById('billItemsContainer'), totalPointsDisplay = document.getElementById('totalPointsDisplay'), modeTabsContainer = document.getElementById('pos-mode-tabs');
        let allProducts = [], billItems = [], currentMode = 'product';

        try { allProducts = await fetchData('getProducts'); updateProductDropdown(); } catch (e) { productListSelect.innerHTML = `<option disabled selected>โหลดสินค้าล้มเหลว</option>`; }
        
        function updateProductDropdown() {
            const productIdsInBill = billItems.map(item => item.id);
            const availableProducts = allProducts.filter(p => !productIdsInBill.includes(p.id));
            productListSelect.innerHTML = '';
            if (availableProducts.length > 0) {
                availableProducts.forEach(p => { const option = document.createElement('option'); option.value = p.id; option.textContent = `${p.name} (${p.points} แต้ม)`; productListSelect.appendChild(option); });
            } else { productListSelect.innerHTML = '<option disabled selected>เพิ่มสินค้าครบแล้ว</option>'; }
        }

        function renderBill() {
            billContainer.innerHTML = ''; let totalPoints = 0;
            if (billItems.length === 0) { billContainer.innerHTML = '<p class="text-center text-gray-400">ยังไม่มีรายการ</p>'; totalPointsDisplay.textContent = '0'; return; }
            billItems.forEach(item => {
                const itemPoints = item.points * item.quantity; totalPoints += itemPoints;
                const itemDiv = document.createElement('div'); 
                itemDiv.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                itemDiv.innerHTML = `<div><span class="font-semibold">${item.name}</span> <span class="text-sm text-gray-500">x ${item.quantity}</span></div><div class="flex items-center gap-2"><span class="font-bold text-thm-secondary">${itemPoints} แต้ม</span><button type="button" class="p-1 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-500 remove-item-btn" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>`;
                billContainer.appendChild(itemDiv);
            });
            totalPointsDisplay.textContent = totalPoints.toLocaleString();
            billContainer.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.onclick = (e) => { billItems = billItems.filter(item => item.id !== e.currentTarget.dataset.id); renderBill(); updateProductDropdown(); };
            });
        }

        modeTabsContainer.addEventListener('click', (e) => {
            const tab = e.target.closest('button[role="tab"]');
            if (!tab) return;
            currentMode = tab.dataset.mode;
            modeTabsContainer.querySelectorAll('button').forEach(t => {
                t.classList.remove('bg-thm-primary', 'text-white', 'shadow');
                t.classList.add('text-gray-700');
            });
            tab.classList.add('bg-thm-primary', 'text-white', 'shadow');
            tab.classList.remove('text-gray-700');
            productModeSection.classList.toggle('hidden', currentMode !== 'product');
            manualModeSection.classList.toggle('hidden', currentMode !== 'manual');
        });

        addItemBtn.onclick = () => {
            const selectedId = productListSelect.value; if (!selectedId) return;
            const product = allProducts.find(p => p.id === selectedId);
            const quantity = parseInt(quantityInput.value, 10);
            if (product && quantity > 0) { billItems.push({ ...product, quantity }); renderBill(); updateProductDropdown(); quantityInput.value = 1; }
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            const identifier = document.getElementById('addPointsIdentifier').value.trim();
            const stampsToAdd = parseInt(document.getElementById('addStampsAmount').value, 10) || 0;
            if (!identifier) return showAlert('ข้อมูลไม่ครบ', 'กรุณาระบุลูกค้า');
            
            let payload = { identifier, stampsToAdd };
            let totalPoints = 0;

            if (currentMode === 'product') {
                totalPoints = billItems.reduce((sum, item) => sum + (item.points * item.quantity), 0);
                if (billItems.length > 0) {
                    payload.itemsPurchased = billItems.map(item => ({ productId: item.id, quantity: item.quantity }));
                }
            } else {
                const points = document.getElementById('addPointsAmount').value;
                const reason = document.getElementById('addPointsReason').value.trim();
                totalPoints = parseInt(points, 10) || 0;
                if (totalPoints > 0) {
                    if (!reason) return showAlert('ข้อมูลไม่ครบ', 'กรุณากรอกเหตุผลสำหรับการให้แต้ม');
                    payload.points = totalPoints;
                    payload.reason = reason;
                }
            }

            if (totalPoints <= 0 && stampsToAdd <= 0) return showAlert('ข้อมูลไม่ครบ', 'กรุณาเพิ่มรายการสินค้า, กรอกแต้ม, หรือระบุจำนวนแสตมป์');

            let confirmParts = [];
            if (totalPoints > 0) confirmParts.push(`ให้ ${totalPoints} แต้ม`);
            if (stampsToAdd > 0) confirmParts.push(`ให้ ${stampsToAdd} แสตมป์`);
            const confirmMessage = `ยืนยันการทำรายการ?\n\n- ${confirmParts.join('\n- ')}\n\nสำหรับผู้ใช้: "${identifier}"`;

            if (await showConfirm('ยืนยันรายการ', confirmMessage)) {
                submitBtn.disabled = true;
                try {
                    const message = await postData('addPointsToUser', payload);
                    showAlert('สำเร็จ', message || 'ทำรายการเรียบร้อยแล้ว');
                    form.reset();
                    document.getElementById('addStampsAmount').value = 0;
                    billItems = []; 
                    renderBill(); 
                    updateProductDropdown();
                } catch(e) { /* handled */ } 
                finally { submitBtn.disabled = false; }
            }
        };
        renderBill();
    }
    
    async function initWarehouse() {
        const tableBody = document.getElementById('warehouseTableBody'), searchInput = document.getElementById('warehouseSearchInput'), statusFilter = document.getElementById('warehouseStatusFilter'), searchBtn = document.getElementById('warehouseSearchBtn');
        searchBtn.onclick = () => loadWarehouseItems(); searchInput.addEventListener('keypress', e => e.key === 'Enter' && searchBtn.click()); statusFilter.onchange = () => loadWarehouseItems(); await loadWarehouseItems();
        async function loadWarehouseItems() { tableBody.innerHTML = `<tr><td colspan="7" class="py-12 text-center"><div class="inline-block loading-spinner"></div></td></tr>`; try { const items = await fetchData('getWarehouseItems', { query: searchInput.value, status: statusFilter.value }); renderWarehouseTable(items); } catch (e) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-red-500">Load failed</td></tr>`; } }
        function renderWarehouseTable(items) { if (!items.length) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">ไม่พบข้อมูล</td></tr>`; return; } tableBody.innerHTML = items.map(i => { const shippingInfo = i.shippingName ? `<div class="text-xs"><strong>${i.shippingName}</strong><br>${i.shippingPhone}<br><div class="whitespace-normal">${i.shippingAddress}</div></div>` : '-'; const actionBtn = i.status === 'claimed' ? `<div class="text-xs text-green-600 font-semibold">ยืนยันแล้ว<br>${i.claimDate}</div>` : `<button class="px-2 py-1 text-xs font-medium rounded-md bg-green-100 text-green-700 hover:bg-green-200 claim-btn">ยืนยัน</button>`; return `<tr class="hover:bg-gray-50"><td class="px-4 py-3">${i.warehouseId}</td><td class="px-4 py-3">${i.itemName}</td><td class="px-4 py-3 font-mono text-xs">${i.lineId}</td><td class="px-4 py-3">${shippingInfo}</td><td class="px-4 py-3">${i.redeemDate}</td><td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${i.status === 'claimed' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">${i.status.replace('_', ' ')}</span></td><td class="px-4 py-3">${actionBtn}</td></tr>`; }).join(''); tableBody.querySelectorAll('.claim-btn').forEach((b,i) => b.onclick = () => claimItem(items[i].warehouseId)); }
        async function claimItem(id) { if (await showConfirm('Confirm', `ยืนยันการรับ/จัดส่งสำหรับ ${id}?`)) { try { await postData('claimWarehouseItemAdmin', { warehouseId: id }); showAlert('Success', 'อัปเดตสถานะสำเร็จ', () => loadWarehouseItems()); } catch (e) { /* handled */ } } }
    }

    async function initScanClaim() {
        const readerElement = document.getElementById('qr-reader'), startBtn = document.getElementById('startScanBtn'), stopBtn = document.getElementById('stopScanBtn'), resultElement = document.getElementById('scan-result');
        let html5QrCode = null;
        const onScanSuccess = async (decodedText) => { await stopScanning(); resultElement.innerHTML = `<div class="inline-block h-5 w-5 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"></div>`; try { const responseText = await postData('claimItemByUniqueId', { uniqueId: decodedText }); showAlert('ผลการยืนยัน', responseText); resultElement.innerHTML = responseText.includes('สำเร็จ') ? `<span class="text-green-600">✅ ${responseText}</span>` : `<span class="text-orange-600">⚠️ ${responseText}</span>`; } catch (error) { resultElement.innerHTML = `<span class="text-red-600">❌ ${error.message}</span>`; } };
        const startScanning = () => { if (!html5QrCode) { html5QrCode = new Html5Qrcode("qr-reader"); } html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, ()=>{}) .then(() => { startBtn.classList.add('hidden'); stopBtn.classList.remove('hidden'); resultElement.textContent = 'กรุณาหันกล้องไปที่ QR Code'; }).catch(err => showAlert("ข้อผิดพลาด", "ไม่สามารถเปิดกล้องได้")); };
        const stopScanning = async () => { if (html5QrCode && html5QrCode.isScanning) { try { await html5QrCode.stop(); startBtn.classList.remove('hidden'); stopBtn.classList.add('hidden'); } catch (err) { console.error("Failed to stop scanning.", err); } } };
        startBtn.onclick = startScanning; stopBtn.onclick = stopScanning;
        window.addEventListener('hashchange', stopScanning, { once: true });
    }

    async function initHistory() {
        const tableBody = document.getElementById('historyTableBody'); const [lineIdInput, typeSelect, startDateInput, endDateInput, filterBtn, resetBtn] = ['historySearchLineId', 'historyFilterType', 'historyStartDate', 'historyEndDate', 'historyFilterBtn', 'historyResetBtn'].map(id => document.getElementById(id)); filterBtn.onclick = loadHistory; resetBtn.onclick = () => { lineIdInput.value = ''; typeSelect.value = ''; startDateInput.value = ''; endDateInput.value = ''; loadHistory(); }; await loadHistory();
        async function loadHistory() { tableBody.innerHTML = `<tr><td colspan="6" class="py-12 text-center"><div class="inline-block loading-spinner"></div></td></tr>`; try { const history = await fetchData('getAllHistory', { lineId: lineIdInput.value, type: typeSelect.value, startDate: startDateInput.value, endDate: endDateInput.value }); renderHistoryTable(history); } catch (e) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-500">Load failed</td></tr>`; } }
        function renderHistoryTable(history) { if (!history.length) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">ไม่พบข้อมูล</td></tr>`; return; } tableBody.innerHTML = history.map(h => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-mono text-xs">${h.lineId}</td><td class="px-4 py-3">${h.type}</td><td class="px-4 py-3">${h.detail}</td><td class="px-4 py-3 font-bold ${h.amount < 0 ? 'text-red-500' : 'text-green-600'}">${h.amount > 0 ? '+' : ''}${h.amount}</td><td class="px-4 py-3">${h.date}</td><td class="px-4 py-3">${h.refId || '-'}</td></tr>`).join(''); }
    }
    
    async function initSettings() {
        const form = document.getElementById('levelSettingsForm'); const vipInput = document.getElementById('vipPoints'); const superInput = document.getElementById('superPoints');
        try { const config = await fetchData('getLevelConfig'); vipInput.value = config.VIP_points; superInput.value = config.SUPER_points; } catch (e) { /* handled */ }
        form.onsubmit = async (e) => { e.preventDefault(); const vip = parseInt(vipInput.value), superP = parseInt(superInput.value); if (isNaN(vip) || isNaN(superP)) return showAlert('Error', 'กรุณากรอกตัวเลข'); if (vip > 0 && superP > 0 && vip >= superP) return showAlert('Error', 'แต้ม SUPER ต้องมากกว่า VIP'); const btn = document.getElementById('saveLevelSettingsBtn'); btn.disabled = true; try { await postData('setLevelConfig', { VIP_points: vip, SUPER_points: superP }); showAlert('Success', 'บันทึกการตั้งค่าแล้ว'); } catch(e) {/* handled */ } finally { btn.disabled = false; } };
    }

    // ==========================================================
    // ===          GENERIC TABLE VIEW & CONFIGS            ===
    // ==========================================================

    const TABLE_CONFIGS = {
        items: {
            title: "ของรางวัล",
            getAction: "getItems",
            deleteAction: "deleteItem",
            saveAction: { add: "addItem", update: "updateItem" },
            headers: ["ID", "ชื่อ", "พ้อยต์", "ประเภท", "รูปภาพ", "จัดการ"],
            renderRow: (item) => `<tr class="hover:bg-gray-50"><td class="px-4 py-3">${item.id}</td><td class="px-4 py-3 font-semibold">${item.name}</td><td class="px-4 py-3">${item.point.toLocaleString()}</td><td class="px-4 py-3"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-thm-accent text-gray-800">${item.type}</span></td><td class="px-4 py-3">${item.image ? `<img src="${item.image}" class="w-12 h-12 object-cover rounded-lg">` : '-'}</td><td class="px-4 py-3"><div class="flex gap-2"><button class="px-2 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 edit-btn">แก้ไข</button> <button class="px-2 py-1 text-xs font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200 delete-btn">ลบ</button></div></td></tr>`,
            formFields: (item) => `<input type="text" name="id" placeholder="ID (auto)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" ${item ? 'readonly' : ''} value="${item ? item.id : ''}" /><input type="text" name="name" placeholder="Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${item ? item.name : ''}" /><input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${item ? item.point : ''}" /><select name="type" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"><option value="digital" ${item && item.type === 'digital' ? 'selected' : ''}>Digital</option><option value="physical" ${item && item.type === 'physical' ? 'selected' : ''}>Physical</option></select><input type="url" name="image" placeholder="Image URL" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${item ? item.image : ''}" />`,
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim() || undefined, name: form.querySelector('[name=name]').value.trim(), point: parseInt(form.querySelector('[name=point]').value), type: form.querySelector('[name=type]').value, image: form.querySelector('[name=image]').value.trim() })
        },
        products: {
            title: "สินค้า",
            getAction: "getProducts",
            deleteAction: "deleteProduct",
            saveAction: { add: "addProduct", update: "updateProduct" },
            headers: ["ID", "ชื่อสินค้า", "หมวดหมู่", "ราคา", "แต้ม/หน่วย", "จัดการ"],
            renderRow: (p) => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-mono text-xs">${p.id}</td><td class="px-4 py-3"><div class="font-bold">${p.name}</div><div class="text-xs text-gray-500 truncate max-w-xs">${p.description || '-'}</div></td><td class="px-4 py-3"><span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-200 text-gray-700">${p.category || '-'}</span></td><td class="px-4 py-3">${p.price.toLocaleString()}</td><td class="px-4 py-3"><span class="font-bold text-green-600">${p.points}</span></td><td class="px-4 py-3"><div class="flex gap-2"><button class="px-2 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 edit-btn">แก้ไข</button> <button class="px-2 py-1 text-xs font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200 delete-btn">ลบ</button></div></td></tr>`,
            formFields: (p) => `<input type="text" name="id" placeholder="ID (auto-generate if empty)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" ${p ? 'readonly' : ''} value="${p ? p.id : ''}" /><input type="text" name="name" placeholder="ชื่อสินค้า" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${p ? p.name : ''}" /><textarea name="description" placeholder="รายละเอียดสินค้า (ไม่บังคับ)" class="w-full px-4 py-2 border border-gray-300 rounded-lg h-20">${p ? (p.description || '') : ''}</textarea><input type="text" name="category" placeholder="หมวดหมู่ (เช่น เครื่องดื่ม)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${p ? (p.category || '') : ''}" /><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">ราคา (บาท)</label><input type="number" name="price" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${p ? p.price : '0'}" min="0" step="any" /></div><div><label class="block text-sm font-medium text-gray-700 mb-1">แต้มที่ได้/หน่วย</label><input type="number" name="points" placeholder="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${p ? p.points : '0'}" min="0" /></div></div>`,
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim() || undefined, name: form.querySelector('[name=name]').value.trim(), description: form.querySelector('[name=description]').value.trim(), category: form.querySelector('[name=category]').value.trim(), price: parseFloat(form.querySelector('[name=price]').value), points: parseInt(form.querySelector('[name=points]').value, 10) })
        },
        events: {
            title: "กิจกรรม",
            getAction: "getEvents",
            deleteAction: "deleteEvent",
            saveAction: { add: "addEvent", update: "updateEvent" },
            headers: ["ID", "ชื่อกิจกรรม", "พ้อยต์", "ระดับที่เข้าร่วมได้", "รูปภาพ", "จัดการ"],
            renderRow: (e) => `<tr class="hover:bg-gray-50"><td class="px-4 py-3">${e.id}</td><td class="px-4 py-3">${e.title}</td><td class="px-4 py-3">${e.point}</td><td class="px-4 py-3">${(e.allowedLevels || []).map(l => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-transparent border border-gray-300 text-gray-600 mr-1">${l}</span>`).join(' ') || 'ทุกคน'}</td><td class="px-4 py-3">${e.image ? `<img src="${e.image}" class="w-12 h-12 object-cover rounded-lg">` : '-'}</td><td class="px-4 py-3"><div class="flex gap-2"><button class="px-2 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 edit-btn">แก้ไข</button> <button class="px-2 py-1 text-xs font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200 delete-btn">ลบ</button></div></td></tr>`,
            formFields: (e) => { const levelsHtml = USER_LEVELS.map(l => `<label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="allowedLevels" value="${l}" class="rounded border-gray-300 text-thm-primary focus:ring-thm-primary" ${e?.allowedLevels?.includes(l) ? 'checked' : ''}><span class="text-sm">${l}</span></label>`).join(''); return `<input type="text" name="id" placeholder="ID (auto)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" ${e ? 'readonly' : ''} value="${e ? e.id : ''}" /><input type="text" name="title" placeholder="Title" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${e ? e.title : ''}" /><input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${e ? e.point : 0}" /><div><label class="block text-sm font-medium text-gray-700 mb-2">ระดับที่เข้าร่วมได้ (ไม่เลือก=ทุกคน)</label><div class="flex flex-wrap gap-4">${levelsHtml}</div></div><textarea name="desc" placeholder="Description" class="w-full px-4 py-2 border border-gray-300 rounded-lg h-24">${e ? (e.desc || '') : ''}</textarea><input type="url" name="image" placeholder="Image URL" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="${e ? (e.image || '') : ''}" />`;},
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim() || undefined, title: form.querySelector('[name=title]').value.trim(), point: parseInt(form.querySelector('[name=point]').value, 10), desc: form.querySelector('[name=desc]').value.trim(), image: form.querySelector('[name=image]').value.trim(), allowedLevels: Array.from(form.querySelectorAll('input[name="allowedLevels"]:checked')).map(cb => cb.value) })
        },
        codes: {
            title: "โค้ด",
            getAction: "getCodes",
            deleteAction: "deleteCode",
            saveAction: { add: "addCode", update: "updateCode" },
            headers: ["ID (QR Code)", "ชื่อโค้ด", "พ้อยต์", "รายละเอียด", "จัดการ"],
            renderRow: (c) => `<tr class="hover:bg-gray-50"><td class="px-4 py-3 font-mono text-xs">${c.id}</td><td class="px-4 py-3">${c.title}</td><td class="px-4 py-3">${c.point}</td><td class="px-4 py-3 max-w-xs truncate">${c.desc || '-'}</td><td class="px-4 py-3"><div class="flex gap-2"><button class="px-2 py-1 text-xs font-medium rounded-md bg-purple-100 text-purple-700 hover:bg-purple-200 qr-gen-btn">QR</button> <button class="px-2 py-1 text-xs font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 edit-btn">แก้ไข</button> <button class="px-2 py-1 text-xs font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200 delete-btn">ลบ</button></div></td></tr>`,
            formFields: (c) => `<input type="text" name="id" placeholder="ID (QR Value)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" ${c ? 'readonly' : 'required'} value="${c ? c.id : ''}" /><input type="text" name="title" placeholder="Title" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${c ? c.title : ''}" /><input type="number" name="point" placeholder="Points" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required value="${c ? c.point : 0}" /><textarea name="desc" placeholder="Description" class="w-full px-4 py-2 border border-gray-300 rounded-lg h-24">${c ? (c.desc || '') : ''}</textarea>`,
            getFormData: (form) => ({ id: form.querySelector('[name=id]').value.trim(), title: form.querySelector('[name=title]').value.trim(), point: parseInt(form.querySelector('[name=point]').value, 10), desc: form.querySelector('[name=desc]').value.trim() }),
            afterRender: () => { document.querySelectorAll('.qr-gen-btn').forEach(btn => { btn.onclick = (e) => { const row = e.target.closest('tr'); const id = row.cells[0].textContent; const title = row.cells[1].textContent; const qrModal = document.getElementById('qrCodeModal'); const canvas = document.getElementById('qrCodeCanvas'); qrModal.querySelector('#qrCodeModalTitle').textContent = `QR Code: ${title}`; canvas.innerHTML = ''; new QRCode(canvas, { text: id, width: 256, height: 256 }); qrModal.showModal(); }; });}
        }
    };
    
    async function initGenericTableView(config) {
        const tableHeader = document.getElementById('tableHeaderRow');
        const tableBody = document.getElementById('tableBody');
        const addNewBtn = document.getElementById('addNewBtn');

        addNewBtn.textContent = `เพิ่ม${config.title}ใหม่`;
        addNewBtn.onclick = () => showFormModal(config);
        tableHeader.innerHTML = config.headers.map(h => `<th class="px-4 py-3">${h}</th>`).join('');

        async function loadData() {
            tableBody.innerHTML = `<tr><td colspan="${config.headers.length}" class="py-12 text-center"><div class="inline-block loading-spinner"></div></td></tr>`;
            try {
                const data = await fetchData(config.getAction);
                renderTable(data, config);
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="${config.headers.length}" class="text-center p-4 text-red-500">Load failed</td></tr>`;
            }
        }

        function renderTable(data, config) {
            if (!data || !data.length) {
                tableBody.innerHTML = `<tr><td colspan="${config.headers.length}" class="text-center p-4 text-gray-500">ไม่พบข้อมูล</td></tr>`;
                return;
            }
            tableBody.innerHTML = data.map(item => config.renderRow(item)).join('');
            tableBody.querySelectorAll('.edit-btn').forEach((b, i) => b.onclick = () => showFormModal(config, data[i]));
            tableBody.querySelectorAll('.delete-btn').forEach((b, i) => b.onclick = () => deleteItem(config, data[i].id));
            if (config.afterRender) config.afterRender();
        }

        function showFormModal(config, item = null) {
            const isEdit = !!item;
            dataFormModalTitle.textContent = `${isEdit ? 'แก้ไข' : 'เพิ่ม'}${config.title}`;
            formFieldsContainer.innerHTML = config.formFields(item);
            dataFormModal.showModal();
            formSaveBtn.onclick = () => saveItem(config, isEdit);
            formCancelBtn.onclick = () => dataFormModal.close();
        }

        async function saveItem(config, isEdit) {
            const data = config.getFormData(formFieldsContainer);
            if (!data.name && !data.title && !data.id) return showAlert('ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลสำคัญ');
            
            formSaveBtn.disabled = true;
            try {
                const action = isEdit ? config.saveAction.update : config.saveAction.add;
                await postData(action, data);
                showAlert('สำเร็จ', `${config.title}ถูก${isEdit ? 'แก้ไข' : 'เพิ่ม'}แล้ว`, () => {
                    dataFormModal.close();
                    loadData();
                });
            } catch (e) { /* handled */ } finally {
                formSaveBtn.disabled = false;
            }
        }

        async function deleteItem(config, id) {
            if (await showConfirm('ยืนยันการลบ', `ต้องการลบ ${config.title} ID: ${id} ใช่หรือไม่?`)) {
                try {
                    await postData(config.deleteAction, { id });
                    showAlert('สำเร็จ', `ลบ ${config.title} เรียบร้อยแล้ว`, loadData);
                } catch (e) { /* handled */ }
            }
        }
        await loadData();
    }


    // --- App Start ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!CONFIG.GAS_URL_ADMIN || CONFIG.GAS_URL_ADMIN === "YOUR_GOOGLE_APPS_SCRIPT_ADMIN_URL_HERE") {
            document.body.innerHTML = '<div class="p-8 text-center text-red-500"><b>Configuration Error:</b> Please set `CONFIG.GAS_URL_ADMIN` in the script tag.</div>';
            return;
        }
        
        // Generate Menu
        const menuContainer = document.getElementById('main-menu');
        menuContainer.innerHTML = MENU_STRUCTURE.map(item => {
            if (item.title) {
                return `<li class="px-4 pt-4 pb-2 text-sm font-semibold text-gray-500 uppercase tracking-wider">${item.title}</li>`;
            }
            return `<li><a href="${item.href}" class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200">${item.name}</a></li>`;
        }).join('');
        
        handleLogin();
        window.addEventListener('hashchange', router);
    });
</script>

</body>
</html>
